flowchart TD
    A[Start NotifyBot] --> B[Parse CLI Arguments]
    B --> C[Setup Logging & Rotate Log Files]
    C --> D[Validate Base Folder]
    D --> E{Base Folder Valid?}
    E -->|No| F[Log Error & Exit]
    E -->|Yes| G[Check Required Files]
    G --> H{Required Files Present?}
    H -->|No| I[Throw MissingRequiredFilesError]
    H -->|Yes| J[Validate From Address]
    J --> K{From Address Valid?}
    K -->|No| L[Throw Invalid From Address Error]
    K -->|Yes| M{Dry Run Mode?}
    
    M -->|Yes| N[Load Approver Emails]
    N --> O{Approvers Found?}
    O -->|No| P[Log Warning & Exit]
    O -->|Yes| Q[Load Subject & Body]
    Q --> R[Load Attachments]
    R --> S[Send Test Email to Approvers]
    S --> T[Log Dry Run Complete]
    T --> U[Exit Success]
    
    M -->|No| V[Load Recipients from to.txt]
    V --> W[Deduplicate to.txt]
    W --> X{Filter File & Inventory Exist?}
    X -->|Yes| Y[Parse Filter Conditions]
    Y --> Z[Read Inventory CSV]
    Z --> AA[Apply Filters to Inventory]
    AA --> BB[Extract Filtered Email IDs]
    BB --> CC[Append to to.txt]
    CC --> DD[Deduplicate to.txt Again]
    X -->|No| EE[Continue with Existing Recipients]
    DD --> EE
    
    EE --> FF[Compile Final Recipient List]
    FF --> GG{Recipients Found?}
    GG -->|No| HH[Throw No Recipients Error]
    GG -->|Yes| II{Force Mode?}
    II -->|No| JJ[Prompt User Confirmation]
    JJ --> KK{User Confirms?}
    KK -->|No| LL[Log Abort & Exit]
    KK -->|Yes| MM[Load Email Content]
    II -->|Yes| MM
    
    MM --> NN[Load Subject & Body HTML]
    NN --> OO[Load Attachments from Subfolder]
    OO --> PP[Start Batch Processing]
    PP --> QQ[Create Email Batch]
    QQ --> RR[Validate Attachments]
    RR --> SS{Attachment Size OK?}
    SS -->|No| TT[Log Warning & Skip]
    SS -->|Yes| UU[Add Attachment to Email]
    TT --> VV
    UU --> VV[Send Email Batch via SMTP]
    VV --> WW{More Batches?}
    WW -->|Yes| XX[Wait Delay Period]
    XX --> QQ
    WW -->|No| YY[Log Completion]
    YY --> ZZ[Exit Success]
    
    F --> AAA[Exit with Error Code 1]
    I --> AAA
    L --> AAA
    HH --> AAA
    LL --> U
    
    style A fill:#e1f5fe
    style M fill:#fff3e0
    style S fill:#f3e5f5
    style VV fill:#e8f5e8
    style AAA fill:#ffebee
    style U fill:#e8f5e8
    style ZZ fill:#e8f5e8
